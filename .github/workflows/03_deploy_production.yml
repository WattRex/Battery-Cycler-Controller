# This workflow deploy system tools to production environment

name: Deploy cycler to PRODUCTION

on:
  pull_request_review:
    types: [submitted]

  pull_request_review:
    types:
      - submitted

jobs:

  build-and-deploy-cycler-on-pr:
    if: ${{ github.event_name == 'pull_request_review' &&
      github.event.review.state == 'approved' &&
      github.event.pull_request.head.ref == 'develop' &&
      github.event.pull_request.base.ref == 'master' }}
    name: Build and publish cycler package
    uses: ./.github/workflows/deploy_packages.yml
    with:
      package-name: wattrex_battery_cycler
      package-path: code/cycler
      source-path: code/cycler/src/wattrex_battery_cycler

  publish-docker-image-cycler:
    name: Publish cycler docker image
    needs: publish-package
    uses: WattRex/Battery-Experiments-Manager/.github/workflows/docker_image.yml@develop
    secrets: inherit
    with:
      dockerfile-path: ./devops/cycler/Dockerfile.cycler
      docker-repo-name: wattrex-battery-cycler
      is-develop: false
      docker-user: ${{ vars.DOCKER_USERNAME_RALDEA }}

  publish-docker-image-db-sync:
    name: Publish db-sync docker image
    needs: publish-package
    uses: WattRex/Battery-Experiments-Manager/.github/workflows/docker_image.yml@develop
    secrets: inherit
    with:
      dockerfile-path: ./devops/db_sync/Dockerfile.db_sync
      docker-repo-name: wattrex-db-sync
      is-develop: false
      docker-user: ${{ vars.DOCKER_USERNAME_RALDEA }}
